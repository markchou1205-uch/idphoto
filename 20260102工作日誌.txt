# 2026/01/02 工作日誌 - 模型輕量化與部署優化

## 1. 核心變更：切換至 Silueta 模型
- **執行項目**：
  - 已移除 `isnet-general-use.onnx` (170MB) 及 Git LFS 設定。
  - 下載並整合 `silueta.onnx` (44MB) 至 `api/` 目錄。
  - **目的**：解決 Vercel 部署失敗 (LFS Error) 並顯著降低 Cold Start 時間。

## 2. 前端修復 (Bug Fix)
- **問題**：`api.js` 在處理小圖（無需縮放）時拋出 `ReferenceError: originalBlob is not defined`，導致「未偵測到人臉」錯誤。
- **解決**：修正邏輯，當無需縮放時正確使用 `base64ToBlob` 產生物件。
- **優化**：增強 `detectFace` 的錯誤日誌輸出，明確顯示錯誤堆疊。

## 5. 精確 300 DPI 裁切 (Strict Logic)
- **問題**：使用者要求絕對精確的像素控制以符合列印標準。
- **修正**：完全重寫 `compositeToWhiteBackground` 邏輯，採用使用者提供的精確公式：
  - **畫布鎖定**：413x531 px (35x45mm @ 300DPI)。
  - **頭高鎖定**：402 px (3.4cm)。
  - **位置計算**：
    - **物理比例歸一化 (Physics-based Normalization)**：完全放棄像素單位的依賴，改用「百分比」進行計算，徹底解決 Resize 造成的數值混亂。
    - **動態閾值 (Dynamic Threshold)**：將去背掃描的噪點閾值改為 `img.width * 0.05` (5%)，自動適應不同解析度，避免頭頂誤判。
    - **最終公式**：
        - `HeadHeight_Pixel = (EyeToTop_Percent / 0.48) * ImgHeight`
        - `Scale = 402 / HeadHeight_Pixel`
        - `DrawY = 50 - (TopY_Percent * ImgHeight * Scale)`

## 6. 錯誤修復 (Bug Fixes)
- **問題**：`compositeToWhiteBackground` 發生 `Cannot read properties of undefined (reading 'pupilLeft')`。
- **原因**：`detectFace` 雖然計算了裁切，但物件返回時漏傳 `faceLandmarks`，導致後續合成函式無法取得五官座標。
- **修正**：
  - 在 `detectFace` 返回物件中補上 `faceLandmarks`。
  - 在 `compositeToWhiteBackground` 加入安全檢查 (`if (faceData && faceData.faceLandmarks)`)，若無特徵點則執行降級處理 (Simple Fit)。

## 7. 代碼重構 (Refactoring) - SSOT
- **目標**：將 300 DPI 幾何運算邏輯抽離，防止未來誤改。
- **行動**：
  - 建立 `js/photoGeometry.js`：存放 `SPECS` 常數與 `calculatePassportLayout` 函數。
  - 修改 `js/api.js`：引入並呼叫上述函數，移除分散的數學計算邏輯。
  - **優點**：確保裁切比例成為「單一事實來源」，不受去背或流程變更影響。

## 8. 規格驗證視覺化 (Visual Verification)
- **目標**：在生成的照片周圍加上尺標與參考線，證明照片符合 300 DPI 與法規定義。
- **行動**：
  - 修改 `api.js`：在畫布外圈增加 60px 邊距，繪製上方 (35mm) 與右方 (45mm) 尺標。
  - 繪製紅色虛線標示頭頂 (Hair Top) 與下巴 (Chin) 位置，並標註 "3.4 cm"。
  - 修改 `ui.js`：下載時偵測長寬比，若為含尺標版本 (Proof Image) 則保留原尺寸，避免強制縮放變形。

## 9. 體驗優化 (UX Polish)
- **目標**：提升製作過程的視覺回饋與完成提示。
- **行動**：
  - **紅線調整**：將參考線移至右側尺標區域，不再穿越照片。
  - **製作完成提示**：流程結束後彈出 "製作完成" alert。
  - **遮罩進度條**：在預覽區增加半透明遮罩與進度條，同步顯示 AI 處理進度。
  - **時序調整**：臉部識別 5秒，其餘步驟 3秒，符合用戶預期心理。
  - **項目補完**：修正「解析度優化」項目未打勾的問題 (Service Index 105)。

## 10. 流程同步與 4x2 預覽 (Sync & Preview)
- **目標**：解決「製作完成」提示早於圖片出現的問題，並實現 4x2 排版的即時預覽功能。
- **行動**：
  - **異步同步**：修改 `ui.js` 的動畫邏輯，在最後步驟 (105) 等待 API Promise 完成後才顯示 100% 與完成提示。
  - **排版預覽**：新增 `show4x2Preview` 功能，點擊下載時先顯示 4x2 網格圖，並提供「直接下載」按鈕。
  - **介面調整**：新增 4x2 專屬的操作面板 (包含「寄到信箱」、「存至雲端」保留位)。

## 11. 審查邏輯深化與狀態管理 (Deep Audit)
- **目標**：讓「合規審查」能針對「製作前」與「製作後」的照片進行正確檢測，並完善介面切換。
- **行動**：
  - **雙重對象檢測**：審查功能現在會自動判斷當前是「原圖」還是「成品」，並對該圖進行檢測。
  - **新增檢測項目**：
    - **圖片尺寸**：比較目前圖片長寬比與選定規格 (Spec) 是否相符。
    - **圖片背景**：針對圖片角落採樣，檢測是否為白底或透明。
    - **圖片像素**：確認解析度是否高於 300 DPI 標準 (寬度 > 413px)。
  - **視圖切換**：點擊「製作」會自動隱藏檢測報告；點擊「審查」才會顯示報告，確保資訊不干擾。

## 12. 規格通用化與動態尺標 (Generic Specs & Dynamic Rulers)
- **目標**：確保除了護照外的其他規格 (如美國簽證 51x51mm) 也能正確裁切與顯示對應尺標。
- **行動**：
  - **參數與邏輯分離**：重構 `photoGeometry.js`，不再依賴寫死的 35x45 參數，改為從 Config 動態計算 (getSpecDims)。
  - **配置擴充**：更新 `config.js`，為所有證件類型加入 `target_head_mm` (目標頭高) 參數。
  - **動態尺標繪製**：修改 `api.js` 中繪製尺標的邏輯，根據傳入的 `spec.width_mm` 動態繪製刻度與公分數值 (非寫死 3.4cm)。
  - **流程串接**：修正 `main.js`，在調用製作流程時正確傳遞當前選擇的規格物件 `DEFAULT_SPECS[state.spec]`。

## 13. 光影均勻度偵測與自動補償 (Lighting & Compensation)
- **目標**：針對「光影不均」的照片 (如頂光、背光) 進行偵測並提供修復能力。
- **行動**：
  - **定義濾鏡常數**：在 `photoGeometry.js` 新增 `IMAGE_PRESETS` (亮度 1.05, 對比 0.92, 飽和 1.05) 作為標準化輸出基底。
  - **Canvas 濾鏡應用**：更新 `api.js` 的 `compositeToWhiteBackground`，在繪製人像前應用 `ctx.filter` 進行亮度與對比調整。
  - **曝光偵測邏輯**：強化 `runCheckApi`，讀取 Azure `exposureLevel`，若非 GoodExposure 則標記為「需補償」。
  - **狀態管理支援**：在 `main.js` 新增 `adjustments` 狀態，並在製作時傳遞給後端邏輯，為未來 UI 的「一鍵修復」與「滑桿微調」預留接口。

## 4. 裁切比例微調 (Fine-tuning)
- **問題**：前次調整雖然解決肩膀問題，但導致頭部佔比過小 (Zoom out too much)。
- **修正**：
  - 頭頂係數 (Hair Top): `1.2` -> `1.0` (恢復標準估算)。
  - 目標比例 (Target Ratio): `0.71` -> `0.75` (稍微拉近，平衡頭部大小與肩膀空間)。

## 3. 裁切優化與 UI 修復
- **裁切邏輯調整**：
  - 頭頂預留係數 (Hair Top Factor)：調整為 `1.2` (原 0.8)，增加頭部上方空間估算，避免過度放大。
  - 目標頭部佔比 (Target Ratio)：調整為 `0.71` (原 0.72)，拉遠鏡頭以納入更多肩膀與胸口區域。
- **UI Bug 修復**：
  - 修正了「重新上傳照片」按鈕在狀態切換後仍維持 Disabled 的問題。

## 2. API 修正 (api/index.py)
- **模型路徑**：更新為 `api/silueta.onnx`。
- **預處理邏輯**：
  - 解析度：調整為 320x320 (Silueta 原生解析度)。
  - 正規化：改用 ImageNet 標準 (Mean=[0.485, 0.456, 0.406], Std=[0.229, 0.224, 0.225])，符合 Rembg/U2Net 規範。

## 3. 驗證狀態
- **本地驗證**：
  - `verify_deployment.py` 測試通過：模型成功載入，輸入張量為 [1, 3, 320, 320]。
  - `test_local.py` 同步更新：確保本地測試腳本與 API 邏輯一致。

## 4. 下一步
- 請推送到 GitHub 並觸發 Vercel 部署。
- 觀察 Vercel Logs，確認 Cold Start 時間是否改善 (預期應在 5s 內)。
- 驗證證件照去背品質（Silueta 在邊緣細節上可能略遜於 ISNet，但在純色背景下通常表現良好）。
