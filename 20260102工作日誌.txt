# 2026/01/02 工作日誌 - 模型輕量化與部署優化

## 1. 核心變更：切換至 Silueta 模型
- **執行項目**：
  - 已移除 `isnet-general-use.onnx` (170MB) 及 Git LFS 設定。
  - 下載並整合 `silueta.onnx` (44MB) 至 `api/` 目錄。
  - **目的**：解決 Vercel 部署失敗 (LFS Error) 並顯著降低 Cold Start 時間。

## 2. 前端修復 (Bug Fix)
- **問題**：`api.js` 在處理小圖（無需縮放）時拋出 `ReferenceError: originalBlob is not defined`，導致「未偵測到人臉」錯誤。
- **解決**：修正邏輯，當無需縮放時正確使用 `base64ToBlob` 產生物件。
- **優化**：增強 `detectFace` 的錯誤日誌輸出，明確顯示錯誤堆疊。

## 5. 精確 300 DPI 裁切 (Strict Logic)
- **問題**：使用者要求絕對精確的像素控制以符合列印標準。
- **修正**：完全重寫 `compositeToWhiteBackground` 邏輯，採用使用者提供的精確公式：
  - **畫布鎖定**：413x531 px (35x45mm @ 300DPI)。
  - **頭高鎖定**：402 px (3.4cm)。
  - **位置計算**：
    - **物理比例歸一化 (Physics-based Normalization)**：完全放棄像素單位的依賴，改用「百分比」進行計算，徹底解決 Resize 造成的數值混亂。
    - **動態閾值 (Dynamic Threshold)**：將去背掃描的噪點閾值改為 `img.width * 0.05` (5%)，自動適應不同解析度，避免頭頂誤判。
    - **最終公式**：
        - `HeadHeight_Pixel = (EyeToTop_Percent / 0.48) * ImgHeight`
        - `Scale = 402 / HeadHeight_Pixel`
        - `DrawY = 50 - (TopY_Percent * ImgHeight * Scale)`

## 4. 裁切比例微調 (Fine-tuning)
- **問題**：前次調整雖然解決肩膀問題，但導致頭部佔比過小 (Zoom out too much)。
- **修正**：
  - 頭頂係數 (Hair Top): `1.2` -> `1.0` (恢復標準估算)。
  - 目標比例 (Target Ratio): `0.71` -> `0.75` (稍微拉近，平衡頭部大小與肩膀空間)。

## 3. 裁切優化與 UI 修復
- **裁切邏輯調整**：
  - 頭頂預留係數 (Hair Top Factor)：調整為 `1.2` (原 0.8)，增加頭部上方空間估算，避免過度放大。
  - 目標頭部佔比 (Target Ratio)：調整為 `0.71` (原 0.72)，拉遠鏡頭以納入更多肩膀與胸口區域。
- **UI Bug 修復**：
  - 修正了「重新上傳照片」按鈕在狀態切換後仍維持 Disabled 的問題。

## 2. API 修正 (api/index.py)
- **模型路徑**：更新為 `api/silueta.onnx`。
- **預處理邏輯**：
  - 解析度：調整為 320x320 (Silueta 原生解析度)。
  - 正規化：改用 ImageNet 標準 (Mean=[0.485, 0.456, 0.406], Std=[0.229, 0.224, 0.225])，符合 Rembg/U2Net 規範。

## 3. 驗證狀態
- **本地驗證**：
  - `verify_deployment.py` 測試通過：模型成功載入，輸入張量為 [1, 3, 320, 320]。
  - `test_local.py` 同步更新：確保本地測試腳本與 API 邏輯一致。

## 4. 下一步
- 請推送到 GitHub 並觸發 Vercel 部署。
- 觀察 Vercel Logs，確認 Cold Start 時間是否改善 (預期應在 5s 內)。
- 驗證證件照去背品質（Silueta 在邊緣細節上可能略遜於 ISNet，但在純色背景下通常表現良好）。
