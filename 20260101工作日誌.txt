# 2026/01/01 工作日誌 - 證件照製作系統修復與優化

## 1. 核心問題解決：全白/鬼影照片修復
- **問題現象**：用戶上傳高解析度照片後，產出的證件照為全白或僅有模糊色塊。
- **根本原因 (Root Cause)**：
  - 前端為了加速 Azure 人臉偵測 API 的上傳速度，將圖片縮小至長邊 1500px。
  - Azure 回傳的人臉座標 (Face Rectangle) 是基於縮小後的圖片。
  - 前端將此「縮小版座標」直接應用於「原始全尺寸圖片」進行裁切，導致裁切區域偏移至背景（通常是左上角），造成 AI 模型接收到空影像。
- **解決方案**：
  - 在前端 `js/api.js` 的 `detectFace` 函式中加入**座標逆向縮放 (Reverse Scaling)** 邏輯。
  - 計算縮放比例（Scale Factor），將 Azure 回傳的座標與五官特徵點 (Landmarks) 乘上比例還原，確保精準裁切到原始人臉。

## 2. 後端模型與影像處理優化
- **模型定案**：
  - 經過多輪測試 (U2NetP, Silueta, ISNet)，最終選用 **ISNet-General-Use (1024x1024)**。
  - 原因：雖然檔案稍大 (110MB)，但其對頭髮邊緣與細節的保留能力最強，且能避免輕量模型出現的破圖問題。
- **正規化修正**：
  - 修正了 `api/index.py` 中遺失的 `img /= 255.0` 步驟，確保輸入數值範圍正確 (0-1)，解決了模型輸出不穩定的問題。

## 3. 前端 UI/UX 改善
- **流程優化**：
  - 修復「開始製作」按鈕在失敗或完成後無法重置的問題。
  - 調整按鈕邏輯：製作完成後，按鈕變更為「重新上傳照片 (Re-upload)」，並綁定頁面刷新功能。
- **視覺回饋**：
  - 在服務步驟列表中新增「臉部識別推算」項目，讓用戶更清楚當前進度。

## 4. 系統穩定性
- **本地驗證環境**：
  - 建立了 `server.py` 與 `reproduce_issue.py`，允許在不依賴 Vercel 部署的情況下快速驗證核心邏輯。
- **診斷機制**：
  - 暫時性實作了「Debug Visualization」模式，輸出 Input/Mask 對比圖，成功協助定位上述的座標偏移問題。

## 5. 部署挑戰與待辦 (23:00 更新)
- **狀況**：
  - 為了縮短 27s -> 5s 的冷啟動時間，嘗試將 `isnet-general-use.onnx` (170MB) 模型內置於專案中。
  - 使用 Git LFS 上傳模型後，Vercel 部署失敗，錯誤訊息 `internal error: [onnxruntimeerror] : 7 : invalid_protobuf`。
  - **診斷**：Vercel 建置過程未能正確拉取 LFS 實體檔案，導致 Runtime 讀取到的是 LFS 指針檔 (Pointer File) 而非模型二進位檔。

- **執行計畫 (明日待辦)**：
  - **方案 A (棄用)**：Vercel 對 LFS 的支援可能不穩定或需額外付費設定，且 170MB 逼近 Lambda 250MB 極限，風險過高。
  - **方案 B (推薦)**：改用輕量級模型 **Silueta (40MB)** 或 **U2NetP (4MB)**。
    - 這能完全繞過 Git LFS 需求。
    - 雖然邊緣細節可能略遜於 ISNet，但在證件照場景下（背景單純）差異應可接受。
    - 體積大幅縮小，能進一步優化冷啟動速度。
  - **行動**：
    1.  移除 LFS 設定與大檔。
    2.  下載 `silueta.onnx` 並改寫 `index.py` 載入它。
    3.  重新部署驗證。

---
**結語**：
系統現已恢復正常運作，且具備更強健的錯誤處理與座標換算機制。祝新年快樂！
