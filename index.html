<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½è­‰ä»¶ç…§æœå‹™</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .preview-box { 
            border: 2px dashed #ccc; 
            min-height: 200px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #fff; 
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        .preview-box:hover { border-color: #0d6efd; box-shadow: 0 0 15px rgba(13, 110, 253, 0.2); }
        .preview-box.selected { border: 3px solid #0d6efd; background-color: #e7f1ff; }
        .preview-box img { max-width: 100%; max-height: 300px; }
        .step-card { background: white; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; padding: 20px; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .step-badge {
            background-color: #0d6efd; color: white; width: 30px; height: 30px;
            border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
            margin-right: 10px; font-weight: bold;
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loading">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h4 class="mt-3 text-primary" id="loading-text">AI æ­£åœ¨ä¿®å¾©èˆ‡å»èƒŒä¸­...</h4>
    <p class="text-muted">è«‹ç¨å€™ï¼Œé€™å¯èƒ½éœ€è¦ 15-30 ç§’</p>
</div>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-primary">ğŸ“· AI æ™ºèƒ½è­‰ä»¶ç…§</h1>
        <p class="text-muted">ä¸Šå‚³è‡ªæ‹ï¼Œä¸€éµç”Ÿæˆæ¨™æº–è­‰ä»¶ç…§ (å«ç¾é¡ã€å»èƒŒã€æ’ç‰ˆ)</p>
    </div>

    <div class="step-card">
        <h4 class="mb-3"><span class="step-badge">1</span>ä¸Šå‚³ç…§ç‰‡</h4>
        <input type="file" class="form-control form-control-lg" id="fileInput" accept="image/*">
        <div class="d-grid gap-2 mt-3">
            <button class="btn btn-primary btn-lg" onclick="uploadAndProcess()">ğŸš€ é–‹å§‹è£½ä½œè­‰ä»¶ç…§</button>
        </div>
    </div>

    <div class="step-card d-none" id="step2">
        <h4 class="mb-3"><span class="step-badge">2</span>é¸æ“‡æ»¿æ„çš„åº•è‰²</h4>
        <p class="text-muted small">é»æ“Šä¸‹æ–¹åœ–ç‰‡é¸æ“‡æ‚¨è¦ä½¿ç”¨çš„ç‰ˆæœ¬</p>
        <div class="row g-4">
            <div class="col-md-6">
                <div class="preview-box" id="box-white" onclick="selectBackground('white')">
                    <span class="text-muted">ç™½åº•é è¦½</span>
                </div>
                <div class="text-center mt-2 fw-bold">ç™½åº• (è­·ç…§/èº«åˆ†è­‰)</div>
            </div>
            <div class="col-md-6">
                <div class="preview-box" id="box-blue" onclick="selectBackground('blue')">
                    <span class="text-muted">è—åº•é è¦½</span>
                </div>
                <div class="text-center mt-2 fw-bold">è—åº• (å±¥æ­·/è­‰æ›¸)</div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <button class="btn btn-success btn-lg px-5 disabled" id="btn-layout" onclick="generateLayout()">
                ğŸ–¨ï¸ è£½ä½œ 4x6 æ²–æ´—æ’ç‰ˆ
            </button>
        </div>
    </div>

    <div class="step-card d-none" id="step3">
        <h4 class="mb-3"><span class="step-badge">3</span>ä¸‹è¼‰èˆ‡åˆ—å°</h4>
        <div class="alert alert-success">
            <strong>æ’ç‰ˆå®Œæˆï¼</strong> æ­¤åœ–ç‰‡ç‚ºæ¨™æº– 4x6 è‹±å‹ (10x15cm)ï¼Œè«‹ç›´æ¥ä¸‹è¼‰ä¸¦é€è‡³è¶…å•†åˆ—å°ã€‚
        </div>
        <div class="text-center mb-3">
            <img id="layout-result" class="img-fluid border rounded shadow-sm" style="max-height: 400px;">
        </div>
        <div class="row g-2">
            <div class="col-md-6 d-grid">
                <a id="btn-download" class="btn btn-dark btn-lg">â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡</a>
            </div>
            <div class="col-md-6 d-grid">
                <button class="btn btn-outline-primary btn-lg" onclick="alert('Email åŠŸèƒ½å°šæœªé€£çµè³‡æ–™åº«ï¼Œè«‹å…ˆä½¿ç”¨ä¸‹è¼‰åŠŸèƒ½ã€‚')">ğŸ“§ å¯„åˆ°ä¿¡ç®±</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= CONFIG =================
    // è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨çš„ Cloudflare Tunnel ç¶²å€ (ä¸»æ§æ©Ÿ Proxy)
    const API_BASE_URL = "https://video.pdfsolution.dpdns.org"; 
    // ==========================================

    let currentPhotoBase64 = ""; // æš«å­˜é¸ä¸­çš„ç…§ç‰‡ (å–®å¼µ)
    let photosData = []; // æš«å­˜å¾Œç«¯å›å‚³çš„ [ç™½åº•, è—åº•]

    function showLoading(show, text="è™•ç†ä¸­...") {
        const el = document.getElementById('loading');
        document.getElementById('loading-text').innerText = text;
        el.style.display = show ? 'flex' : 'none';
    }

    async function uploadAndProcess() {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files.length) {
            alert('è«‹å…ˆé¸æ“‡ä¸€å¼µç…§ç‰‡ï¼');
            return;
        }

        showLoading(true, "AI æ­£åœ¨é€²è¡Œäººè‡‰ä¿®å¾©èˆ‡å»èƒŒ...");
        
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onloadend = async function() {
            const base64data = reader.result;
            
            try {
                // å‘¼å«å¾Œç«¯ API
                const response = await fetch(`${API_BASE_URL}/generate/preview`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image_base64: base64data,
                        spec_id: "TWN_PASSPORT",
                        bg_color: "#FFFFFF" // é€™è£¡ä¸»è¦è§¸ç™¼é è¦½é‚è¼¯
                    })
                });

                const data = await response.json();

                if (response.ok && data.photos) {
                    // é¡¯ç¤ºæ­¥é©Ÿ 2
                    document.getElementById('step2').classList.remove('d-none');
                    document.getElementById('step3').classList.add('d-none');
                    
                    // å„²å­˜è³‡æ–™: photos[0] æ˜¯ç™½åº•, photos[1] æ˜¯è—åº•
                    photosData = data.photos;

                    // æ›´æ–°é è¦½åœ–
                    document.getElementById('box-white').innerHTML = `<img src="data:image/jpeg;base64,${data.photos[0]}">`;
                    document.getElementById('box-blue').innerHTML = `<img src="data:image/jpeg;base64,${data.photos[1]}">`;
                    
                    // æ»¾å‹•åˆ°æ­¥é©Ÿ 2
                    document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('è™•ç†å¤±æ•—: ' + (data.error || data.message));
                }
            } catch (error) {
                console.error(error);
                alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨ç‹€æ…‹ã€‚');
            } finally {
                showLoading(false);
            }
        };
        reader.readAsDataURL(file);
    }

    function selectBackground(color) {
        // ç§»é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
        document.querySelectorAll('.preview-box').forEach(el => el.classList.remove('selected'));
        
        // è¨­å®šç•¶å‰é¸ä¸­
        if (color === 'white') {
            document.getElementById('box-white').classList.add('selected');
            currentPhotoBase64 = photosData[0];
        } else {
            document.getElementById('box-blue').classList.add('selected');
            currentPhotoBase64 = photosData[1];
        }

        // å•Ÿç”¨æ’ç‰ˆæŒ‰éˆ•
        const btn = document.getElementById('btn-layout');
        btn.classList.remove('disabled');
        btn.innerText = `ğŸ–¨ï¸ ä½¿ç”¨${color === 'white' ? 'ç™½åº•' : 'è—åº•'}è£½ä½œæ’ç‰ˆ`;
    }

    async function generateLayout() {
        if (!currentPhotoBase64) return;

        showLoading(true, "æ­£åœ¨ç”Ÿæˆ 4x6 æ²–æ´—æ’ç‰ˆ...");

        try {
            const response = await fetch(`${API_BASE_URL}/generate/layout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image_base64: currentPhotoBase64,
                    layout_type: "2_inch_8",
                    paper_size: "4x6"
                })
            });

            const data = await response.json();

            if (data.layout_image) {
                // é¡¯ç¤ºæ­¥é©Ÿ 3
                document.getElementById('step3').classList.remove('d-none');
                
                // é¡¯ç¤ºæ’ç‰ˆåœ–
                const imgUrl = `data:image/jpeg;base64,${data.layout_image}`;
                document.getElementById('layout-result').src = imgUrl;
                
                // è¨­å®šä¸‹è¼‰æŒ‰éˆ•
                const dlBtn = document.getElementById('btn-download');
                dlBtn.href = imgUrl;
                dlBtn.download = `id_photo_layout_${Date.now()}.jpg`;

                // æ»¾å‹•åˆ°æ­¥é©Ÿ 3
                document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert("æ’ç‰ˆç”Ÿæˆå¤±æ•—");
            }
        } catch (e) {
            alert("é€£ç·šéŒ¯èª¤: " + e);
        } finally {
            showLoading(false);
        }
    }
</script>

</body>
</html>
