# --- å‰ç«¯ç¶²é  (HTML + CSS + JS) ---
# é€™è£¡è¨­è¨ˆæˆå¤šæœå‹™åˆ‡æ›çš„ç•Œé¢ï¼Œæ‰€æœ‰ç·¨è¼¯éƒ½åœ¨ Canvas ä¸Šé€²è¡Œ
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åœ–åƒå®¢è£½åŒ–æœå‹™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f7f9fc; }
        .service-tab.active { border-bottom: 3px solid #007bff; color: #007bff; font-weight: 600; }
        .service-tab:not(.active):hover { color: #4a5568; }
        .photo-specs-select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
        #image-container { position: relative; width: 100%; max-width: 500px; margin: 0 auto; }
        #image-canvas { border: 2px solid #007bff; border-radius: 8px; margin-top: 10px; }
        .edit-slider { width: 100%; height: 6px; background: #e0e7ff; border-radius: 3px; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">ğŸ“¸ AI åœ–åƒå®¢è£½åŒ–æœå‹™</h1>
        
        <!-- æœå‹™åˆ‡æ›æ¨™ç±¤ -->
        <div class="flex border-b mb-6 text-gray-500">
            <button class="service-tab active px-4 py-2 text-sm" data-service="id-photo" onclick="switchService('id-photo')">è­‰ä»¶ç…§ç”Ÿæˆ</button>
            <button class="service-tab px-4 py-2 text-sm" data-service="job-photo" onclick="switchService('job-photo')">æ±‚è·ç…§/æ›è£</button>
            <button class="service-tab px-4 py-2 text-sm" data-service="hair-style" onclick="switchService('hair-style')">è®Šæ›é«®å‹</button>
        </div>

        <!-- è­¦å‘Š/æç¤ºå€ -->
        <div id="status-message" class="bg-yellow-100 text-yellow-800 p-3 rounded-lg text-sm mb-6 hidden"></div>

        <!-- ä¸»å…§å®¹å€ -->
        <div id="service-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- æª”æ¡ˆä¸Šå‚³èˆ‡ç·¨è¼¯å€ (å·¦å´) -->
            <div class="lg:col-span-2">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">ä¸Šå‚³èˆ‡ç·¨è¼¯</h2>
                
                <!-- åœ–ç‰‡ä¸Šå‚³ -->
                <input type="file" id="fileInput" accept="image/*" class="mb-4 hidden" onchange="handleFileUpload()">
                <button onclick="document.getElementById('fileInput').click()" 
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition duration-150">
                    ä¸Šå‚³æ‚¨çš„ç…§ç‰‡
                </button>

                <!-- åœ–åƒå®¹å™¨ -->
                <div id="image-container" class="mt-4 bg-gray-100 border border-gray-300 rounded-lg p-2 text-center relative">
                    <canvas id="image-canvas" class="w-full h-auto rounded-md hidden"></canvas>
                    <p id="canvas-placeholder" class="py-10 text-gray-500">è«‹å…ˆä¸Šå‚³åœ–ç‰‡</p>
                    
                    <!-- è¼‰å…¥å’ŒéŒ¯èª¤æç¤º -->
                    <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-70 flex flex-col items-center justify-center rounded-lg hidden">
                        <svg class="animate-spin h-8 w-8 text-blue-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="loading-text" class="text-gray-700 font-semibold">AI å¯©æ ¸ä¸­...</span>
                    </div>
                </div>
                
                <!-- è­‰ä»¶ç…§å°ˆå±¬ï¼šè£å‰ªå·¥å…·æç¤º -->
                <p id="crop-hint" class="text-xs text-gray-500 mt-2 hidden">è«‹æ‹–æ›³ã€ç¸®æ”¾ Canvas èª¿æ•´é ­éƒ¨ä½ç½®å’Œå¤§å°ã€‚</p>

            </div>
            
            <!-- æ§åˆ¶é¢æ¿ (å³å´) -->
            <div id="control-panel" class="lg:col-span-1 space-y-6">
                
                <!-- æœå‹™é¸å–® -->
                <div id="id-photo-controls">
                    <h2 class="text-lg font-semibold mb-2">è­‰ä»¶ç…§è¦æ ¼</h2>
                    <select id="spec-selector" class="photo-specs-select" onchange="updateSpecDescription()">
                        <!-- é¸é …å°‡ç”± JS è¼‰å…¥ -->
                    </select>
                    <p id="spec-description" class="text-xs text-gray-600 mt-1 h-10"></p>
                </div>
                
                <!-- ç¾é¡èˆ‡ä¿®å¾©æ»‘æ¡¿ (æ¨¡æ“¬æ•ˆæœ) -->
                <div id="beauty-controls">
                    <h2 class="text-lg font-semibold mb-3">ç¾é¡/ä¿®å¾© (é è¦½)</h2>
                    
                    <!-- çœ¼ç›æ”¾å¤§ -->
                    <div>
                        <label for="eyeSize" class="block text-sm font-medium text-gray-700">çœ¼ç›æ”¾å¤§ (æ¨¡æ“¬)</label>
                        <input type="range" id="eyeSize" min="0" max="10" value="0" class="edit-slider" oninput="applyCanvasEffects()">
                    </div>
                    
                    <!-- æ³•ä»¤ç´‹æ¶ˆé™¤ (æ¨¡æ“¬) -->
                    <div>
                        <label for="wrinkle" class="block text-sm font-medium text-gray-700">æ¶ˆé™¤çšºç´‹/æ³•ä»¤ç´‹ (æ¨™è¨˜å¾Œç”Ÿæ•ˆ)</label>
                        <input type="range" id="wrinkle" min="0" max="100" value="0" class="edit-slider" disabled>
                        <p class="text-xs text-gray-500 mt-1">æ­¤æ•ˆæœéœ€å¾Œç«¯ AI è™•ç†ï¼Œæ»‘æ¡¿åƒ…ä¾›åƒè€ƒå¼·åº¦ã€‚</p>
                    </div>
                </div>

                <!-- æäº¤æŒ‰éˆ• -->
                <button id="submit-btn" onclick="handleSubmit()" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-150"
                        disabled>
                    âœ… å…è²»é è¦½ (ä½è§£æåº¦)
                </button>
                <button id="download-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-lg transition duration-150 mt-2 hidden" onclick="startPaidProcess()">
                    ğŸ’° ä»˜è²»ä¸‹è¼‰é«˜è§£æåº¦
                </button>
            </div>
            
        </div>

        <!-- çµæœé¡¯ç¤ºå€ -->
        <div id="result-display" class="mt-8 pt-6 border-t hidden">
            <h2 class="text-xl font-semibold mb-4 text-center">ç”Ÿæˆçµæœé è¦½</h2>
            <div id="result-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- é è¦½ç…§ç‰‡å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>

    </div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    const SPECS = {{ specs | tojson }}; // ä¾†è‡ª Flask å‚³è¼¸çš„è¦æ ¼æ•¸æ“š
    let originalImage = null;
    const canvas = document.getElementById('image-canvas');
    const ctx = canvas.getContext('2d');
    const statusMessage = document.getElementById('status-message');
    const specSelector = document.getElementById('spec-selector');
    const beautyControls = document.getElementById('beauty-controls');
    
    // è¨­ç½® Canvas åˆå§‹å°ºå¯¸ (ç”¨æ–¼ç¸®æ”¾)
    const CANVAS_WIDTH = 500;
    const CANVAS_HEIGHT = 400;
    canvas.width = CANVAS_WIDTH;
    canvas.height = CANVAS_HEIGHT;

    document.addEventListener('DOMContentLoaded', () => {
        populateSpecSelector();
        switchService('id-photo'); // é è¨­å•Ÿå‹•è­‰ä»¶ç…§æœå‹™
    });
    
    // --- æœå‹™åˆ‡æ›é‚è¼¯ ---
    function switchService(serviceId) {
        document.querySelectorAll('.service-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.service === serviceId) {
                tab.classList.add('active');
            }
        });

        // éš±è—/é¡¯ç¤ºæ§åˆ¶é …
        document.getElementById('id-photo-controls').style.display = serviceId === 'id-photo' ? 'block' : 'none';
        beautyControls.style.display = (serviceId === 'id-photo' || serviceId === 'job-photo') ? 'block' : 'none';
        
        // è®Šæ›´æŒ‰éˆ•æ–‡æœ¬
        const submitBtn = document.getElementById('submit-btn');
        if (serviceId === 'id-photo') {
            submitBtn.innerText = 'âœ… å…è²»é è¦½ (åŸºç¤ä¿®å¾©)';
        } else {
            submitBtn.innerText = 'âœ¨ é–‹å§‹é«˜éšç”Ÿæˆ (é€²éšä»˜è²»)';
        }
        
        // æ¸…é™¤ç‹€æ…‹å’Œ Canvas
        statusMessage.classList.add('hidden');
        document.getElementById('result-display').classList.add('hidden');
        drawPlaceholder();
    }
    
    function drawPlaceholder() {
        ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        document.getElementById('canvas-placeholder').style.display = 'block';
        canvas.classList.add('hidden');
    }

    // --- è¦æ ¼é¸æ“‡é‚è¼¯ ---
    function populateSpecSelector() {
        specSelector.innerHTML = SPECS.map(spec => 
            `<option value="${spec.country}">${spec.name} (${spec.photo_width_mm}x${spec.photo_height_mm}mm)</option>`
        ).join('');
        updateSpecDescription();
    }
    
    function updateSpecDescription() {
        const selectedCountry = specSelector.value;
        const spec = SPECS.find(s => s.country === selectedCountry);
        if (spec) {
            document.getElementById('spec-description').innerHTML = 
                `èƒŒæ™¯ï¼š<span class="font-bold">${spec.ai_rules.background_color}</span> | è¦å‰‡ï¼šéœ²è€³ï¼š${spec.ai_rules.ear_exposure ? 'æ˜¯' : 'å¦'}`;
        }
    }

    // --- æª”æ¡ˆè™•ç†èˆ‡ Canvas ç¹ªåœ–é‚è¼¯ ---
    function handleFileUpload() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                originalImage = img;
                // åˆå§‹åŒ– Canvas
                canvas.classList.remove('hidden');
                document.getElementById('canvas-placeholder').style.display = 'none';
                document.getElementById('submit-btn').disabled = false;
                
                // ç¹ªè£½åŸå§‹åœ–åƒ
                drawOriginalImage();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    function drawOriginalImage() {
        if (!originalImage) return;
        
        // 1. æ¸…é™¤
        ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        
        // 2. è¨ˆç®—æ¯”ä¾‹ä»¥é©æ‡‰ Canvas
        const ratio = Math.min(CANVAS_WIDTH / originalImage.width, CANVAS_HEIGHT / originalImage.height);
        const newWidth = originalImage.width * ratio;
        const newHeight = originalImage.height * ratio;
        
        // 3. ç¹ªè£½åˆ° Canvas ä¸­å¤®
        const x = (CANVAS_WIDTH - newWidth) / 2;
        const y = (CANVAS_HEIGHT - newHeight) / 2;
        ctx.drawImage(originalImage, x, y, newWidth, newHeight);

        // 4. æ‡‰ç”¨æ¨¡æ“¬æ•ˆæœ (ä¾‹å¦‚çœ¼ç›æ”¾å¤§)
        applyCanvasEffects();
        
        // è¨­ç½®æ‹–æ›³å’Œç¸®æ”¾åŠŸèƒ½ (ç°¡åŒ–ï¼šé€™è£¡åƒ…ç‚ºæ¡†æ¶ï¼Œå¯¦éš›è£å‰ªéœ€å¼•å…¥å¤–éƒ¨åº«æˆ–è¤‡é›œ JS é‚è¼¯)
        document.getElementById('crop-hint').classList.remove('hidden');
    }
    
    function applyCanvasEffects() {
        // --- é€™è£¡å°‡æ˜¯æ¨¡æ“¬ 'çœ¼ç›æ”¾å¤§' çš„é‚è¼¯ ---
        // é€™æ˜¯ A é¡ï¼ˆå¹¾ä½•è®Šå½¢ï¼‰åŠŸèƒ½çš„å‰ç«¯æ¨¡æ“¬é»
        
        const eyeSize = parseInt(document.getElementById('eyeSize').value);
        if (eyeSize > 0) {
            // ç”±æ–¼ Canvas å¹¾ä½•è®Šå½¢è¤‡é›œï¼Œé€™è£¡åƒ…å±•ç¤ºæ•ˆæœé‚è¼¯çš„å‘¼å«é»
            // çœŸæ­£çš„æ¶²åŒ–æ•ˆæœéœ€è¦ç²å–äººè‡‰é—œéµé»ï¼Œä¸¦ä½¿ç”¨åƒç´ è‘—è‰²å™¨æˆ–è¤‡é›œ JS ç®—æ³•ã€‚
            statusMessage.innerText = `[æ¨¡æ“¬é è¦½] çœ¼ç›æ”¾å¤§å¼·åº¦: ${eyeSize}. æœ€çµ‚æ•ˆæœéœ€å¾Œç«¯è™•ç†ã€‚`;
            statusMessage.classList.remove('hidden');
        } else {
            statusMessage.classList.add('hidden');
        }
        
        // é€™è£¡éœ€è¦é‡æ–°ç¹ªè£½ä»¥é¡¯ç¤ºè®Šå½¢
        // drawOriginalImage(); // é‡æ–°ç¹ªåœ–å°‡æœƒæ¸…é™¤å·²æœ‰çš„è®Šå½¢ï¼Œå¯¦éš›éœ€è¤‡é›œçš„è®Šå½¢åœ–å±¤ç®¡ç†
    }

    // --- æäº¤èˆ‡ API é‚è¼¯ ---
    async function handleSubmit() {
        const currentService = document.querySelector('.service-tab.active').dataset.service;
        const submitBtn = document.getElementById('submit-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const downloadBtn = document.getElementById('download-btn');
        
        submitBtn.disabled = true;
        downloadBtn.classList.add('hidden');
        loadingOverlay.classList.remove('hidden');
        document.getElementById('loading-text').innerText = 'AI å¯©æ ¸èˆ‡ä¿®å¾©ä¸­...';

        try {
            // ç²å– Canvas æœ€çµ‚åœ–åƒ (åŒ…å«å‰ç«¯è£å‰ªå’Œæ¨¡æ“¬è®Šå½¢)
            const finalImageURL = canvas.toDataURL('image/jpeg', 0.9);
            const base64Image = finalImageURL.split(',')[1];
            
            let targetUrl = '';
            let payload = {};

            if (currentService === 'id-photo') {
                // è­‰ä»¶ç…§ï¼šç™¼é€åˆ°å…è²»é è¦½ç«¯é»
                const selectedSpec = specSelector.value;
                targetUrl = '/generate/preview'; // æ–°å¢çš„å…è²»é è¦½ç«¯é»
                payload = { 
                    image_base64: base64Image,
                    spec_id: selectedSpec,
                    edit_params: { eye_size: document.getElementById('eyeSize').value } // å‚³è¼¸ç·¨è¼¯åƒæ•¸
                };
            } else if (currentService === 'job-photo') {
                // æ±‚è·ç…§ï¼šç›´æ¥é€²å…¥ä»˜è²»é«˜éšè™•ç†
                targetUrl = '/generate/advanced';
                payload = { 
                    image_base64: base64Image,
                    style_id: 'standard_business'
                };
            } else {
                return;
            }


            const response = await fetch(targetUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            
            if (!response.ok || data.error) {
                 // I. åš´é‡ä¸åˆæ ¼æ‹’çµ•
                 if (data.status === 'REJECTED') {
                    statusMessage.innerText = `ğŸš¨ åš´é‡ä¸åˆæ ¼ï¼š${data.message}ã€‚è«‹é‡æ‹ï¼`;
                    statusMessage.classList.remove('hidden');
                    return;
                 }
                 // II. ä¸­åº¦ä¸åˆæ ¼è©¢å• (é€™è£¡åªå±•ç¤ºéŒ¯èª¤ï¼Œå¯¦éš›æ‡‰å½ˆå‡ºç¢ºèªæ¡†)
                 if (data.status === 'NEEDS_CONFIRMATION') {
                    statusMessage.innerText = `âš ï¸ ä¸­åº¦ä¸åˆæ ¼ï¼š${data.message}ã€‚AI å¯ä¿®è£œï¼Œæ˜¯å¦ä»˜è²»ä¿®è£œï¼Ÿ`;
                    statusMessage.classList.remove('hidden');
                    // é€™è£¡æ‡‰å½ˆå‡ºæ¨¡æ…‹æ¡†
                    downloadBtn.classList.remove('hidden'); // æš«æ™‚ç”¨ä¸‹è¼‰æŒ‰éˆ•æ¨¡æ“¬ä»˜è²»ä¿®è£œé¸é …
                    downloadBtn.innerText = 'ä¿®è£œä¸¦ä¸‹è¼‰ (ä»˜è²»)';
                    return;
                 }
                 
                 throw new Error(data.error || "å¾Œç«¯è™•ç†å¤±æ•—");
            }
            
            // III. æˆåŠŸæˆ–ä½åº¦ä¸åˆæ ¼è‡ªå‹•ä¿®å¾©å®Œæˆ
            if (data.status === 'OK' || data.status === 'AUTO_FIXED') {
                displayResults(data.photos);
                downloadBtn.classList.remove('hidden');
                downloadBtn.innerText = 'ğŸ’° ä»˜è²»ä¸‹è¼‰é«˜è§£æåº¦';
                statusMessage.innerText = data.message || 'âœ… é è¦½ç”ŸæˆæˆåŠŸã€‚';
                statusMessage.classList.remove('hidden');
            }


        } catch (error) {
            statusMessage.innerText = "âŒ è«‹æ±‚å¤±æ•—: " + error.message;
            statusMessage.classList.remove('hidden');
        } finally {
            submitBtn.disabled = false;
            loadingOverlay.classList.add('hidden');
        }
    }
    
    function displayResults(photos) {
        // ... (çœç•¥ displayResults å‡½å¼å…§å®¹ï¼Œèˆ‡èˆŠç‰ˆé¡ä¼¼ï¼Œç”¨æ–¼é¡¯ç¤º Base64 åœ–ç‰‡) ...
        const photoGrid = document.getElementById('result-grid');
        photoGrid.innerHTML = '';
        
        photos.forEach((base64Str, index) => {
            const item = document.createElement('div');
            item.className = 'photo-item';
            
            const img = document.createElement('img');
            img.src = 'data:image/jpeg;base64,' + base64Str;
            
            const p = document.createElement('p');
            p.innerText = `é è¦½ #${index + 1}`;
            
            item.appendChild(img);
            item.appendChild(p);
            photoGrid.appendChild(item);
        });
        
        document.getElementById('result-display').classList.remove('hidden');
    }
    
    function startPaidProcess() {
        alert("é€™è£¡å°‡å•Ÿå‹•ä»˜è²»æµç¨‹ä¸¦èª¿ç”¨ /generate/paid ç«¯é»...");
        // å¯¦éš›æ‡‰è©²ç™¼é€æ–°çš„è«‹æ±‚åˆ° /generate/paid ç«¯é»ç²å–é«˜è§£æåº¦ç„¡æµ®æ°´å°ç…§ç‰‡
    }

</script>

</body>
</html>
