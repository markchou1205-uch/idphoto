<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½è­‰ä»¶ç…§æœå‹™</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .preview-box { 
            border: 2px dashed #ccc; 
            min-height: 200px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #fff; /* èƒŒæ™¯ä¿æŒç™½è‰² */
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px; /* å¢åŠ å…§è·ï¼Œè®“åœ–ç‰‡ä¸è²¼é‚Š */
        }
        .preview-box:hover { border-color: #0d6efd; box-shadow: 0 0 15px rgba(13, 110, 253, 0.2); }
        .preview-box.selected { border: 3px solid #0d6efd; background-color: #e7f1ff; }
        
        /* --- ä¿®æ”¹é»ï¼šçµ¦åœ–ç‰‡åŠ ä¸Šé‚Šæ¡† --- */
        .preview-box img { 
            max-width: 100%; 
            max-height: 300px; 
            border: 1px solid #dee2e6; /* æ·ºç°è‰²å¯¦ç·šé‚Šæ¡† */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* è¼•å¾®é™°å½±è®“å®ƒæµ®èµ·ä¾† */
        }

        .step-card { background: white; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; padding: 20px; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .step-badge {
            background-color: #0d6efd; color: white; width: 30px; height: 30px;
            border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
            margin-right: 10px; font-weight: bold;
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loading">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h4 class="mt-3 text-primary" id="loading-text">è™•ç†ä¸­...</h4>
    <p class="text-muted">è«‹ç¨å€™ï¼ŒAI æ­£åœ¨é‹ç®—</p>
</div>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-primary">ğŸ“· AI æ™ºèƒ½è­‰ä»¶ç…§</h1>
        <p class="text-muted">ä¸Šå‚³è‡ªæ‹ï¼Œä¸€éµç”Ÿæˆæ¨™æº–è­‰ä»¶ç…§</p>
    </div>

    <div class="step-card">
        <h4 class="mb-3"><span class="step-badge">1</span>ä¸Šå‚³ç…§ç‰‡</h4>
        <input type="file" class="form-control form-control-lg" id="fileInput" accept="image/*">
        <div class="d-grid gap-2 mt-3">
            <button class="btn btn-primary btn-lg" onclick="uploadAndProcess()">ğŸš€ é–‹å§‹è£½ä½œè­‰ä»¶ç…§</button>
        </div>
    </div>

    <div class="step-card d-none" id="step2">
        <h4 class="mb-3"><span class="step-badge">2</span>é¸æ“‡åº•è‰²</h4>
        <div class="row g-4">
            <div class="col-md-6">
                <div class="preview-box" id="box-white" onclick="selectBackground('white')">
                    <span class="text-muted">è¼‰å…¥ä¸­...</span>
                </div>
                <div class="text-center mt-2 fw-bold">ç™½åº• (è­·ç…§/èº«åˆ†è­‰)</div>
            </div>
            <div class="col-md-6">
                <div class="preview-box" id="box-blue" onclick="selectBackground('blue')">
                    <span class="text-muted">è¼‰å…¥ä¸­...</span>
                </div>
                <div class="text-center mt-2 fw-bold">è—åº• (å±¥æ­·/è­‰æ›¸)</div>
            </div>
        </div>
        <div class="text-center mt-4">
            <button class="btn btn-success btn-lg px-5 disabled" id="btn-layout" onclick="generateLayout()">
                ğŸ–¨ï¸ è£½ä½œ 4x6 æ²–æ´—æ’ç‰ˆ
            </button>
        </div>
    </div>

    <div class="step-card d-none" id="step3">
        <h4 class="mb-3"><span class="step-badge">3</span>ä¸‹è¼‰èˆ‡åˆ—å°</h4>
        <div class="alert alert-success">
            <strong>æ’ç‰ˆå®Œæˆï¼</strong> åœ–ç‰‡å·²åŠ ä¸Šé‚Šæ¡†ï¼Œå¯ç›´æ¥æŸ¥çœ‹ç¯„åœã€‚
        </div>
        <div class="text-center mb-3">
            <img id="layout-result" class="img-fluid border rounded shadow-sm" style="max-height: 400px; border: 1px solid #333;">
        </div>
        <div class="row g-2">
            <div class="col-md-12 d-grid">
                <a id="btn-download" class="btn btn-dark btn-lg">â¬‡ï¸ ä¸‹è¼‰æ’ç‰ˆåœ–ç‰‡</a>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= CONFIG =================
    // è«‹ç¢ºèªæ­¤ç¶²å€æ­£ç¢º
    const API_BASE_URL = "https://video.pdfsolution.dpdns.org"; 
    // ==========================================

    let photosData = []; 
    let selectedColor = "";

    function showLoading(show, text="è™•ç†ä¸­...") {
        const el = document.getElementById('loading');
        document.getElementById('loading-text').innerText = text;
        el.style.display = show ? 'flex' : 'none';
    }

    async function uploadAndProcess() {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files.length) { alert('è«‹å…ˆé¸æ“‡ç…§ç‰‡ï¼'); return; }

        showLoading(true, "AI æ­£åœ¨ä¿®å¾©èˆ‡å»èƒŒ (ç´„15-30ç§’)...");
        
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onloadend = async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/generate/preview`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image_base64: reader.result,
                        spec_id: "TWN_PASSPORT",
                        bg_color: "#FFFFFF"
                    })
                });

                if (!response.ok) throw new Error("ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤");
                
                const data = await response.json();
                if (data.photos) {
                    photosData = data.photos;
                    document.getElementById('step2').classList.remove('d-none');
                    document.getElementById('step3').classList.add('d-none');
                    
                    document.getElementById('box-white').innerHTML = `<img src="data:image/jpeg;base64,${data.photos[0]}">`;
                    document.getElementById('box-blue').innerHTML = `<img src="data:image/jpeg;base64,${data.photos[1]}">`;
                    
                    document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('è™•ç†å¤±æ•—: ' + (data.error || "æœªçŸ¥éŒ¯èª¤"));
                }
            } catch (error) {
                console.error(error);
                alert('é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            } finally {
                showLoading(false);
            }
        };
        reader.readAsDataURL(file);
    }

    function selectBackground(color) {
        document.querySelectorAll('.preview-box').forEach(el => el.classList.remove('selected'));
        if (color === 'white') {
            document.getElementById('box-white').classList.add('selected');
            selectedColor = photosData[0];
        } else {
            document.getElementById('box-blue').classList.add('selected');
            selectedColor = photosData[1];
        }
        document.getElementById('btn-layout').classList.remove('disabled');
    }

    async function generateLayout() {
        if (!selectedColor) return;
        showLoading(true, "æ­£åœ¨ç”Ÿæˆæ’ç‰ˆå¤§åœ– (è«‹è€å¿ƒç­‰å¾…)...");

        try {
            const response = await fetch(`${API_BASE_URL}/generate/layout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image_base64: selectedColor, // å‚³é€ Base64
                    layout_type: "2_inch_8",
                    paper_size: "4x6"
                })
            });
            
            // è™•ç† Failed to fetch
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.status} - ${errText}`);
            }

            const data = await response.json();
            if (data.layout_image) {
                document.getElementById('step3').classList.remove('d-none');
                const imgUrl = `data:image/jpeg;base64,${data.layout_image}`;
                document.getElementById('layout-result').src = imgUrl;
                
                const dlBtn = document.getElementById('btn-download');
                dlBtn.href = imgUrl;
                dlBtn.download = `layout_${Date.now()}.jpg`;
                
                document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert("ç”Ÿæˆå¤±æ•—: " + (data.error || "ç„¡è³‡æ–™å›å‚³"));
            }
        } catch (e) {
            console.error(e);
            alert("é€£ç·šéŒ¯èª¤ (Failed to fetch): è³‡æ–™é‡å¯èƒ½éå¤§æˆ–ç¶²è·¯ä¸ç©©ã€‚è«‹é‡æ–°æ•´ç†ç¶²é å†è©¦ä¸€æ¬¡ã€‚");
        } finally {
            showLoading(false);
        }
    }
</script>

</body>
</html>
