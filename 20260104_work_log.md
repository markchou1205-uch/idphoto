# 2026-01-04 Work Log

## Summary
Successfully refactored the ID Photo application's compliance review system, shifting it to a post-production phase to improve user experience and reduce API costs. Also addressed critical API deprecation issues and implemented new geometry features for better photo alignment.

## Completed Tasks

### 1. Compliance Review Refactoring
- **Workflow Change**: Moved compliance checks to occur *after* photo production.
- **Optimization**: Consolidated Azure Face API calls. Modified `detectFace` to request full face attributes (`glasses`, `occlusion`, `headPose`) in the initial call, eliminating the second `runCheckApi` call.
- **Local Validation**: Replaced server-side validation checks with client-side logic using cached API data (`state.faceData`).
- **UI Updates**:
  - Removed pre-production audit button.
  - Added "Run Compliance Audit" button to the result/download panel.
  - Implemented a detailed, animated compliance report table.
  - Added specific check for "Manually Confirm Ears" (雙耳可見 - 人工確認).

### 2. Critical Bug Fix (Azure API)
- **Issue**: Azure Face API returned 403 Forbidden due to the deprecation of the `smile` attribute.
- **Fix**: Removed `smile` from the request parameters in `js/api.js` and updated `main.js` to rely solely on facial landmarks for mouth/expression checks.

### 3. Geometry & UI Enhancements
- **Nose-Tip Auto-Centering**: Updated `calculateUniversalLayout` in `js/photoGeometry.js` to align the subject's nose tip (or eye midpoint) to the horizontal center of the canvas, ensuring better framing.
- **Report Animation**: Implemented a sequential "checking" animation in the compliance report (Spinner -> Result) to provide better user feedback.

## Files Modified
- `index.html`: Cleaned up action buttons.
- `main.js`: Refactored state management and audit flow.
- `js/api.js`: Optimized API requests and fixed deprecation error.
- `js/ui.js`: Implemented new report UI and animations.
- `js/photoGeometry.js`: Implemented nose-centering logic.

## Commits
- `Refactor: Move compliance review to post-production and optimize API calls`
- `Fix: Remove deprecated smile attribute from Azure Face API request`
- `Feat: Implement compliance check animation and nose-tip auto-centering`
