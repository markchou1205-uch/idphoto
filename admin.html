<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åƒæ•¸å¾Œå°ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding: 20px; }
        .card { margin-bottom: 20px; }
        .param-row { padding: 10px 0; border-bottom: 1px solid #eee; }
        .param-desc { font-size: 0.85rem; color: #666; }
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="card p-4" style="width: 350px;">
        <h4 class="text-center mb-3">ğŸ” ç®¡ç†å“¡ç™»å…¥</h4>
        <input type="password" id="admin-pwd" class="form-control mb-3" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        <button class="btn btn-primary w-100" onclick="doLogin()">ç™»å…¥</button>
    </div>
</div>

<div class="container" style="max-width: 800px; display: none;" id="main-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">âš™ï¸ AI åƒæ•¸å‹•æ…‹èª¿æ•´</h3>
        <div>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="logout()">ç™»å‡º</button>
            <button class="btn btn-outline-danger me-2" onclick="resetConfig()">é‡ç½®é è¨­å€¼</button>
            <button class="btn btn-primary" onclick="saveConfig()">å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <div id="config-container">Loading...</div>
</div>

<script>
    // GPU Server IP
    const API_URL = "https://video.pdfsolution.dpdns.org"; 
    let adminToken = "";

    function doLogin() {
        const pwd = document.getElementById('admin-pwd').value;
        if (!pwd) return;
        adminToken = pwd;
        loadConfig(); // å˜—è©¦è¼‰å…¥ï¼Œå¦‚æœæˆåŠŸå°±éš±è—ç™»å…¥æ¡†
    }

    function logout() {
        localStorage.removeItem('adminToken');
        location.reload();
    }

    async function loadConfig() {
        try {
            const res = await fetch(`${API_URL}/admin/config`, {
                headers: { 'x-admin-token': adminToken }
            });
            
            if (res.status === 401) {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                return;
            }
            
            if (!res.ok) throw new Error("API Error");

            const data = await res.json();
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            localStorage.setItem('adminToken', adminToken); // ä¿å­˜ç™»å…¥ç‹€æ…‹
            renderConfig(data);
        } catch (e) {
            console.error(e);
        }
    }

    function renderConfig(config) {
        const container = document.getElementById('config-container');
        container.innerHTML = '';
        
        const groups = {};
        for (const key in config) {
            const item = config[key];
            if (!groups[item.group]) groups[item.group] = [];
            groups[item.group].push({ key, ...item });
        }

        for (const groupName in groups) {
            const card = document.createElement('div');
            card.className = 'card shadow-sm';
            let rowsHtml = '';
            
            groups[groupName].forEach(item => {
                rowsHtml += `
                    <div class="param-row row align-items-center mx-2">
                        <div class="col-md-4">
                            <label class="fw-bold">${item.key}</label>
                            <div class="param-desc">${item.desc}</div>
                        </div>
                        <div class="col-md-6">
                            <input type="${item.type === 'int' || item.type === 'float' ? 'number' : 'text'}" 
                                   class="form-control" 
                                   id="input-${item.key}" 
                                   value="${item.value}" 
                                   step="${item.type === 'float' ? '0.01' : '1'}">
                        </div>
                        <div class="col-md-2 text-end">
                            <span class="badge bg-secondary">${item.type}</span>
                        </div>
                    </div>
                `;
            });

            card.innerHTML = `
                <div class="card-header bg-white fw-bold text-primary">${groupName}</div>
                <div class="card-body">${rowsHtml}</div>
            `;
            container.appendChild(card);
        }
    }

    async function saveConfig() {
        const newValues = {};
        const inputs = document.querySelectorAll('input[id^="input-"]');
        inputs.forEach(input => {
            const key = input.id.replace('input-', '');
            newValues[key] = input.value;
        });

        try {
            const res = await fetch(`${API_URL}/admin/config`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-admin-token': adminToken 
                },
                body: JSON.stringify(newValues)
            });
            if (res.ok) {
                alert("âœ… è¨­å®šå·²å„²å­˜ä¸¦å³æ™‚ç”Ÿæ•ˆï¼");
                loadConfig(); // Reload to reflect changes
            } else {
                alert("å„²å­˜å¤±æ•—");
            }
        } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
    }

    async function resetConfig() {
        if (!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰åƒæ•¸ç‚ºé è¨­å€¼å—ï¼Ÿ")) return;
        try {
            const res = await fetch(`${API_URL}/admin/config/reset`, { 
                method: 'POST',
                headers: { 'x-admin-token': adminToken }
            });
            if (res.ok) {
                alert("å·²é‡ç½®ï¼");
                loadConfig();
            }
        } catch (e) { alert("éŒ¯èª¤"); }
    }

    // Auto login if token saved
    if (localStorage.getItem('adminToken')) {
        adminToken = localStorage.getItem('adminToken');
        loadConfig();
    }
</script>

</body>
</html>
